
import type { FlowerRole } from "./types.js";

// ==========================================
// 1. 游戏规则常量
// ==========================================

export const FLOWER_GAME_RULES = `
## 1. 阵营与获胜条件

- **配置**：9人局（1-9号座位）。
- **好人阵营**：花蝴蝶、医生、警察、狙击手、善民。
- **坏人阵营**：杀手、魔法师、森林老人、恶民。

**获胜判定**

- **好人赢**：坏人阵营里带技能的3个人（杀手、魔法师、森林老人）全部死亡。
- **坏人赢**：好人阵营所有人全部死亡。
- **平局**：场上只剩下没有技能的民（善民/恶民），或所有人同时死亡。

## 2. 角色技能表

### 好人阵营

- **花蝴蝶**：每晚必须选择抱住一名玩家。自己承受的所有效果会同时复制给那名玩家；那名玩家当晚免疫其他所有人的技能。（抱自己等同弃权）
- **医生**：每晚选择一名玩家扎针。如果该玩家受致命伤，则救活；如果该玩家没受致命伤，则记1次“空针”。
- **警察**：每晚查验一名玩家的身份。结果只显示“是坏人阵营的功能牌”或“不是坏人阵营的功能牌”。
- **狙击手**：每晚可以选择射杀一名玩家，也可以不行动。
- **善民**：每晚投一票“暗票”，票数会累积到第二天的白天投票中。

### 坏人阵营

- **杀手**：每晚选择杀害一名玩家。
- **魔法师**：每晚选择封印一名玩家。该玩家当晚技能无法发动。
  - *被动*：杀手死后，继承杀手技能，失去封印技能。
- **森林老人**：每晚选择禁言一名玩家。该玩家第二天不能发言、不能投票、死后没有遗言。
  - *被动*：杀手和魔法师都死后，继承杀手技能。
- **恶民**：每晚投一票“暗票”。被警察查验时，结果显示为“不是坏人阵营的功能牌”。

## 3. 夜晚结算顺序与逻辑

系统在夜晚会严格按照以下三个步骤的顺序来处理所有指令：

### 第一步：魔法师封印

系统首先判断魔法师封印了谁。

- 被封印的玩家，当晚所有行动作废。
- **重点**：如果花蝴蝶被封印，她无法抱人，今晚就没有花蝴蝶的特殊逻辑，所有人正常结算。

### 第二步：花蝴蝶抱人

如果花蝴蝶没被封印，她抱住了一名玩家（我们暂称这名玩家为A）。

- **对玩家A的影响**：玩家A当晚“不在座位上”。除了花蝴蝶，其他任何人对A释放的技能全部**失效**。
- **对花蝴蝶的影响**：花蝴蝶不仅自己承受技能效果，还会把效果**复制**一份给玩家A。

### 第三步：其他技能结算

系统处理杀手、医生、警察、狙击手等的技能。根据上面的情况，会有三种结果：

**情况1：技能指向“被花蝴蝶抱住的人”**

- **判定**：找不到目标。
- **结果**：技能彻底失效。
  - 杀手/狙击手：没杀掉。
  - 医生：没扎上（不救人，也不计空针）。
  - 警察：查验失败（无信息/显示无法查验）。
  - 魔法师：封印失败。

**情况2：技能指向“花蝴蝶”**

- **判定**：双人承受。
- **结果**：技能对花蝴蝶生效，同时对被抱住的人生效。
  - 杀手/狙击手：花蝴蝶死亡，被抱住的人也死亡。
  - 医生：花蝴蝶挨一针，被抱住的人也挨一针（如果都没受伤，两人各记1次空针）。
  - 警察：查验到花蝴蝶的真实身份。

**情况3：技能指向“其他普通人”**

- **判定**：正常结算。

## 4. 特殊规则补充

**关于医生“空针”致死**

- 医生如果扎错人（扎了没受伤的人），该玩家会积累1次空针。
- 当任何一名玩家累计满2次空针（不需要连续），第二天早上直接死亡。
- **注意**：医生只有扎在“座位上”的人才算数。如果扎了被花蝴蝶抱走的人，因为没扎上，所以不计空针。

**关于坏人技能继承**

- 坏人团队只有一把刀。
- **白天死**：如果杀手白天被投死，魔法师当晚直接变杀手。
- **晚上死**：如果杀手晚上被杀（比如被狙击手打死），魔法师当晚还是魔法师，第二天晚上才变杀手。
- 继承顺序：杀手 -> 魔法师 -> 森林老人。

## 5. 游戏流程（从晚上到白天）

晚上各玩家使用技能（不能弃权），天亮结算夜晚技能情况，若出现死者且未被禁言，则死者发表遗言，遗言结束后开始进入发言环节。
各玩家发言结束后，进入投票环节（不能弃权），得票（明票+暗票）最多者出局，且公布身份，若为非坏特殊，且未被禁言，则允许发表遗言。遗言结束后，进入下一个夜晚。
`;

// ==========================================
// 2. AI 决策接口定义
// ==========================================

export interface SpeechPlan {
    /**
     * The semantic intent of what the bot wants to say.
     * This is the raw logical output before style transfer.
     */
    draft: string;

    /**
     * Updated natural language notes about other players.
     */
    updatedPlayerNotes?: string;

    /**
     * A short strategic note summarizing current situation and plan.
     */
    strategicNote: string;

    /**
     * Updated long-term strategy.
     */
    strategicPlan?: string;

    /**
     * The role this bot claims to be.
     */
    claimedRole: import("./types.js").FlowerRole | "无";
}

export interface SpeechDecision extends SpeechPlan {
    /**
     * The actual styled speech content.
     */
    content: string;
}

export interface VoteDecision {
    targetSeat: number; // 0 for abstain/skip
    reason: string;
    /**
     * Updated natural language notes about other players.
     */
    updatedPlayerNotes?: string;
    strategicNote?: string;
    strategicPlan?: string;
    claimedRole?: import("./types.js").FlowerRole | "无";
}

export interface NightActionDecision {
    targetSeat: number | null; // null for no action / skip
    reason: string;
    updatedPlayerNotes?: string;
    strategicPlan?: string;
}
